<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Flow</title>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: Georgia, "Times New Roman", serif;
      background: linear-gradient(180deg, #2b241c, #1f1a15);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: #2a241f;
    }
    
    /* ───────── Top Bar ───────── */
    .top-bar {
      background: linear-gradient(135deg, #3a2f25, #4a3e32);
      padding: 14px 28px;
      border-bottom: 1px solid #5a4a3b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 20px;
    }
    
    .top-bar h1 {
      font-size: 20px;
      font-weight: 600;
      color: #f5ecd9;
      letter-spacing: 0.04em;
    }

    /* ───────── Auth Controls (Top Right) ───────── */
    .auth-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .auth-btn {
      padding: 8px 16px;
      background: #fffdf8;
      color: #2a241f;
      border: 1px solid #d2c3ad;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .auth-btn:hover { background: #f2ead8; transform: translateY(-1px); }
    
    .user-info { display: none; align-items: center; gap: 12px; color: #f5ecd9; font-size: 14px; }

    .btn-sign-out {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid #f5ecd9;
      color: #f5ecd9;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: 0.2s;
    }

    .btn-sign-out:hover { background: #f5ecd9; color: #3a2f25; }

    /* ───────── Search ───────── */
    .search-container { position: relative; width: 320px; }
    .search-field {
      padding: 10px 14px;
      border: 1px solid #7b6753;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      background: #f7f1e6;
    }

    .search-results {
      position: absolute;
      top: 100%; left: 0; right: 0;
      max-height: 350px;
      overflow-y: auto;
      background: #fbf7ef;
      border: 1px solid #d6c7b2;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      z-index: 1000;
    }
    
    .search-result { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #e2d6c4; transition: 0.15s; }
    .search-result:hover { background: #f2ead8; }
    .result-title { font-weight: 600; font-size: 14px; }
    .result-author { font-size: 12px; color: #8a7a67; font-style: italic; }

    /* ───────── Manual Modal ───────── */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-content {
      background: #fffdf8; padding: 30px; border-radius: 12px;
      max-width: 400px; width: 90%; text-align: center;
    }

    /* ───────── Board Layout ───────── */
    .columns-container { display: flex; flex: 1; overflow: hidden; background: #3a2f25; }
    .column { flex: 1; display: flex; flex-direction: column; background: #f8f2e8; border-right: 1px solid #d2c3ad; }
    .column-header { padding: 20px; border-bottom: 2px solid; }
    .column-content { flex: 1; overflow-y: auto; padding: 15px; }

    /* Column Themes */
    .column-1 { background: #f0f7ff; } .column-1 .column-header { border-color: #93c5fd; color: #1e40af; }
    .column-2 { background: #fffbf5; } .column-2 .column-header { border-color: #fb923c; color: #c2410c; }
    .column-3 { background: #fff4e0; } .column-3 .column-header { border-color: #f5a623; color: #d97706; }
    .column-4 { background: #f7fef9; } .column-4 .column-header { border-color: #4ade80; color: #15803d; }

    .book-card {
      background: #fffdf8; padding: 16px; margin-bottom: 12px;
      border-radius: 8px; border: 1px solid #e2d6c4;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: grab;
    }
    .book-title { font-weight: 600; margin-bottom: 4px; cursor: pointer; }
    .book-author { font-size: 13px; color: #6f5f4d; margin-bottom: 10px; }
    
    /* Timeline styling */
    .book-timeline { border-top: 1px solid #eee; padding-top: 10px; font-size: 12px; }
    .timeline-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .timeline-dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; }
    .unlocked .timeline-dot { background: #63b3ed; }
    .milestone-2.unlocked .timeline-dot { background: #f6ad55; }
    .milestone-3.unlocked .timeline-dot { background: #68d391; }
    .locked { opacity: 0.5; font-style: italic; }

    .btn-delete { color: #a65b4b; border: 1px solid #a65b4b; background: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; float: right; font-size: 11px; }
    </style>
</head>
<body>

    <div class="top-bar">
      <h1>Reading Flow</h1>
      <div class="search-container">
        <input type="text" class="search-field" placeholder="Search books...">
        <div class="search-results" id="searchResults"></div>
      </div>
      
      <div class="auth-controls">
        <button class="auth-btn" id="googleSignIn">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
          Sign In
        </button>
        <div class="user-info" id="userInfo">
          <span id="userName"></span>
          <button class="btn-sign-out" id="signOutBtn">Sign Out</button>
        </div>
      </div>
    </div>

    <div class="columns-container">
        <div class="column column-1">
            <div class="column-header"><div style="font-weight:700">PURCHASED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-2">
            <div class="column-header"><div style="font-weight:700">CURRENTLY READING</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-3">
            <div class="column-header"><div style="font-weight:700">FINISHED — NOT RATED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-4">
            <div class="column-header"><div style="font-weight:700">FINISHED & RATED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
    </div>

    <div id="manualModal" class="modal-overlay">
      <div class="modal-content">
        <h2 style="margin-bottom:15px">Manual Entry</h2>
        <input type="text" id="manualTitle" class="search-field" style="margin-bottom:10px" placeholder="Book Title">
        <input type="text" id="manualAuthor" class="search-field" style="margin-bottom:20px" placeholder="Author">
        <div style="display:flex; gap:10px">
          <button onclick="closeManualModal()" class="btn-sign-out" style="color:#2a241f; border-color:#2a241f; flex:1">Cancel</button>
          <button onclick="submitManualEntry()" class="auth-btn" style="flex:1; justify-content:center; background:#3a2f25; color:white">Add</button>
        </div>
      </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDe-AQ70nJ9Lah8ojh4pivmxD0KglHWGHo",
    authDomain: "dusty-s-reading-flow.firebaseapp.com",
    projectId: "dusty-s-reading-flow",
    storageBucket: "dusty-s-reading-flow.firebasestorage.app",
    messagingSenderId: "378730506034",
    appId: "1:378730506034:web:16cc698d8ebb54430d592b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  let searchTimeout;
  let draggedCard = null;

  auth.onAuthStateChanged(async (user) => {
    const signInBtn = document.getElementById('googleSignIn');
    const userInfo = document.getElementById('userInfo');
    const userNameDisplay = document.getElementById('userName');

    if (user) {
      currentUser = user;
      signInBtn.style.display = 'none';
      userInfo.style.display = 'flex';
      userNameDisplay.textContent = user.displayName || user.email;
      await loadBooks();
      setupDropZones();
    } else {
      currentUser = null;
      signInBtn.style.display = 'inline-flex';
      userInfo.style.display = 'none';
      document.querySelectorAll('.column-content').forEach(c => c.innerHTML = '');
      updateAllCounts();
    }
  });

  document.getElementById('googleSignIn').addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider).catch(e => console.error(e));
  });

  document.getElementById('signOutBtn').addEventListener('click', async () => {
    if (confirm('Sign out?')) await auth.signOut();
  });

  function getTodayDate() {
    return new Date().toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Search Logic
  async function searchBooks(query) {
    try {
      const response = await fetch(`https://openlibrary.org/search.json?title=${encodeURIComponent(query)}&limit=5`);
      const data = await response.json();
      return data.docs.map(b => ({ title: b.title, author: b.author_name ? b.author_name[0] : 'Unknown' }));
    } catch { return []; }
  }

  function displayResults(books) {
    const container = document.getElementById('searchResults');
    let html = books.map(b => `
      <div class="search-result" onclick="addBook('${escapeHtml(b.title)}','${escapeHtml(b.author)}')">
        <div class="result-title">${b.title}</div>
        <div class="result-author">${b.author}</div>
      </div>
    `).join('');
    html += `<div class="search-result" onclick="openManualModal()" style="color:#4285f4; font-weight:bold">+ Manual Entry</div>`;
    container.innerHTML = html;
  }

  function openManualModal() { 
    document.getElementById('manualModal').style.display = 'flex'; 
    document.getElementById('searchResults').innerHTML = '';
  }
  function closeManualModal() { document.getElementById('manualModal').style.display = 'none'; }
  async function submitManualEntry() {
    const t = document.getElementById('manualTitle').value;
    const a = document.getElementById('manualAuthor').value || 'Unknown Author';
    if(t) { await addBook(t, a); closeManualModal(); }
  }

  async function addBook(title, author) {
    if (!currentUser) { alert("Please sign in first"); return; }
    const col = document.querySelector('.column-1 .column-content');
    const bookCard = createBookCard({ title, author, downloadedDate: getTodayDate() }, 1);
    col.prepend(bookCard);
    document.querySelector('.search-field').value = '';
    document.getElementById('searchResults').innerHTML = '';
    updateAllCounts();
    await saveBooks();
  }

  function createBookCard(book, colIdx) {
    const card = document.createElement('div');
    card.className = 'book-card';
    card.setAttribute('draggable', 'true');

    const pDate = (book.downloadedDate && book.downloadedDate !== 'N/A') ? book.downloadedDate : "Recently";
    const sDate = (book.startedDate && book.startedDate !== 'N/A') ? book.startedDate : (colIdx >= 2 ? "Recently" : "...");
    const fDate = (book.finishedDate && book.finishedDate !== 'N/A') ? book.finishedDate : (colIdx >= 3 ? "Recently" : "...");

    card.innerHTML = `
      <button class="btn-delete" onclick="deleteBook(this)">Delete</button>
      <div class="book-title">${book.title}</div>
      <div class="book-author">${book.author}</div>
      <div class="book-timeline">
        <div class="timeline-item unlocked"><div class="timeline-dot"></div>Purchased ${pDate}</div>
        <div class="timeline-item ${colIdx >= 2 ? 'unlocked' : 'locked'}"><div class="timeline-dot"></div>Started ${sDate}</div>
        <div class="timeline-item ${colIdx >= 3 ? 'unlocked' : 'locked'}"><div class="timeline-dot"></div>Finished ${fDate}</div>
      </div>
    `;

    card.dataset.downloadedDate = pDate;
    card.dataset.startedDate = sDate === "..." ? "" : sDate;
    card.dataset.finishedDate = fDate === "..." ? "" : fDate;

    card.addEventListener('dragstart', () => { draggedCard = card; card.classList.add('dragging'); });
    card.addEventListener('dragend', () => { draggedCard = null; card.classList.remove('dragging'); });
    return card;
  }

  function setupDropZones() {
    document.querySelectorAll('.column-content').forEach((content, i) => {
      content.addEventListener('dragover', (e) => e.preventDefault());
      content.addEventListener('drop', async () => {
        if (!draggedCard) return;
        const targetIdx = i + 1;
        if (targetIdx === 2 && !draggedCard.dataset.startedDate) draggedCard.dataset.startedDate = getTodayDate();
        if (targetIdx === 3 && !draggedCard.dataset.finishedDate) draggedCard.dataset.finishedDate = getTodayDate();
        
        const newCard = createBookCard({
          title: draggedCard.querySelector('.book-title').textContent,
          author: draggedCard.querySelector('.book-author').textContent,
          downloadedDate: draggedCard.dataset.downloadedDate,
          startedDate: draggedCard.dataset.startedDate,
          finishedDate: draggedCard.dataset.finishedDate
        }, targetIdx);
        
        content.prepend(newCard);
        draggedCard.remove();
        updateAllCounts();
        await saveBooks();
      });
    });
  }

  async function saveBooks() {
    if (!currentUser) return;
    const data = { column1: [], column2: [], column3: [], column4: [] };
    document.querySelectorAll('.column').forEach((col, i) => {
      col.querySelectorAll('.book-card').forEach(c => {
        data[`column${i+1}`].push({
          title: c.querySelector('.book-title').textContent,
          author: c.querySelector('.book-author').textContent,
          downloadedDate: c.dataset.downloadedDate,
          startedDate: c.dataset.startedDate,
          finishedDate: c.dataset.finishedDate
        });
      });
    });
    await db.collection('users').doc(currentUser.uid).collection('books').doc('data').set(data);
  }

  async function loadBooks() {
    const doc = await db.collection('users').doc(currentUser.uid).collection('books').doc('data').get();
    if (doc.exists) {
      const data = doc.data();
      [1,2,3,4].forEach(i => {
        const col = document.querySelector(`.column-${i} .column-content`);
        col.innerHTML = '';
        (data[`column${i}`] || []).forEach(b => col.appendChild(createBookCard(b, i)));
      });
    }
    updateAllCounts();
  }

  function updateAllCounts() {
    document.querySelectorAll('.column').forEach((col, i) => {
      const count = col.querySelectorAll('.book-card').length;
      col.querySelector('.column-subtitle').textContent = `${count} book${count !== 1 ? 's' : ''}`;
    });
  }

  async function deleteBook(btn) { btn.closest('.book-card').remove(); updateAllCounts(); await saveBooks(); }

  document.querySelector('.search-field').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const q = e.target.value.trim();
    if (q.length > 2) searchTimeout = setTimeout(async () => displayResults(await searchBooks(q)), 300);
    else document.getElementById('searchResults').innerHTML = '';
  });

  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('book-title')) window.open(`https://www.goodreads.com/search?q=${encodeURIComponent(e.target.textContent)}`, '_blank');
    if (!e.target.closest('.search-container')) document.getElementById('searchResults').innerHTML = '';
  });
</script>
</body>
</html>
