<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusty's Reading Flow Tool</title>
    <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BASE STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      line-height: 1.55;
      letter-spacing: 0.01em;
      background: linear-gradient(180deg, #2b241c, #1f1a15);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: #2a241f;
    }
    
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOP BAR & AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .top-bar {
      background: linear-gradient(135deg, #3a2f25, #4a3e32);
      padding: 18px 28px;
      border-bottom: 1px solid #5a4a3b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 20px;
    }
    
    .top-bar h1 {
      font-size: 20px;
      font-weight: 600;
      color: #f5ecd9;
      letter-spacing: 0.04em;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
        
    .top-bar h1::before {
      content: '';
      display: inline-block;
      width: 38px;
      height: 28px;
      background-image: url('bookopenicon.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      margin-right: 12px;
      vertical-align: middle;
      mix-blend-mode: multiply;
      opacity: 0.9;
    }
        
    .auth-controls {
      display: flex;
      align-items: center;
      margin-left: auto;
      gap: 12px;
    }

    .auth-btn {
      padding: 8px 16px;
      background: white;
      color: #2a241f;
      border: 1px solid #d2c3ad;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .auth-btn:hover { background: #f5f5f5; transform: translateY(-1px); }
    
    .user-info { display: none; align-items: center; gap: 12px; color: #f5ecd9; font-size: 14px; }

    .btn-sign-out {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid #f5ecd9;
      color: #f5ecd9;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      font-family: Georgia, "Times New Roman", serif;
    }

    .btn-sign-out:hover { background: #f5ecd9; color: #3a2f25; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .search-container { position: relative; width: 320px; flex-shrink: 0; }
    .search-field {
      padding: 10px 14px;
      border: 1px solid #7b6753;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      background: #f7f1e6;
      color: #2a241f;
    }
    .search-field:focus { outline: none; border-color: #c9a76a; box-shadow: 0 0 0 2px rgba(201, 167, 106, 0.25); }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 320px; /* Increased slightly */
      overflow-y: auto;
      background: #fbf7ef;
      border: 1px solid #d6c7b2;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    /* Ensure the manual entry is always at the bottom and visible */
    .search-result:last-child {
      border-bottom: none;
      position: sticky;
      bottom: 0;
      background: #f4faff; /* Slightly different color to stand out */
      border-top: 1px solid #d2c3ad;
    }
    
    .search-result { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #e2d6c4; background: #fbf7ef; transition: background 0.15s ease; color: #3a2f25; }
    .search-result:hover { background: #f2ead8; }
    .result-title { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .result-author { font-size: 12px; color: #8a7a67; font-style: italic; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ COLUMNS & THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .columns-container { display: flex; flex: 1; overflow: hidden; background: linear-gradient(180deg, #3a2f25, #2b241c); }
    .column { flex: 1; display: flex; flex-direction: column; background: #f8f2e8; border-right: 1px solid #d2c3ad; position: relative; }
    .column:last-child { border-right: none; }
    .column-header { padding: 22px 20px; border-bottom: 1px solid #d2c3ad; }
    .column-title { font-size: 15px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; }
    .column-subtitle { font-size: 12px; color: #7a6a57; margin-top: 4px; }
    .column-content { flex: 1; overflow-y: auto; padding: 18px; transition: background-color 0.3s ease, outline 0.3s ease; }

    /* Column Specific Styles (Original Gradients) */
    .column-1 { background: linear-gradient(180deg, #e6f2ff, #f0f7ff); }
    .column-1 .column-header { background: linear-gradient(180deg, #dbeafe, #e6f2ff); border-bottom: 2px solid #93c5fd; }
    .column-1 .column-title { color: #1e40af; }

    .column-2 { background: linear-gradient(180deg, #fff7ed, #fffbf5); }
    .column-2 .column-header { background: linear-gradient(180deg, #fed7aa, #ffedd5); border-bottom: 2px solid #fb923c; }
    .column-2 .column-title { color: #c2410c; }

    .column-3 { background: linear-gradient(180deg, #fff9ed, #fff4e0); box-shadow: inset 0 0 15px rgba(245, 158, 11, 0.1); }
    .column-3 .column-header { background: linear-gradient(180deg, #ffe5b4, #ffd89b); border-bottom: 2px solid #f5a623; }
    .column-3 .column-title { color: #d97706; font-weight: 700; }

    .column-4 { background: linear-gradient(180deg, #f0fdf4, #f7fef9); }
    .column-4 .column-header { background: linear-gradient(180deg, #bbf7d0, #d1fae5); border-bottom: 2px solid #4ade80; }
    .column-4 .column-title { color: #15803d; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BOOK CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .book-card {
      background: linear-gradient(135deg, #fffdf8, #fefbf3);
      padding: 16px 18px;
      margin-bottom: 14px;
      border-radius: 10px;
      border: 1px solid #e2d6c4;
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
      cursor: grab;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .book-card:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.18); }
    .book-card.dragging {
      opacity: 0.4;
      transform: scale(0.95);
      border: 1px dashed #7a6a57;
      box-shadow: none;
    }
    .column-content.drag-over {
      background: rgba(201, 167, 106, 0.15); /* Subtle highlight */
      outline: 2px dashed #c9a76a; /* Dashed border "landing zone" */
      outline-offset: -4px;
      transition: all 0.2s ease;
    }
    
    /* Gold cards in final column */
    .column-4 .book-card {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #d4af37;
      box-shadow: 0 6px 14px rgba(212, 175, 55, 0.3);
    }

    .book-title { font-size: 15px; font-weight: 600; color: #2a241f; margin-bottom: 6px; cursor: pointer; }
    .book-title:hover { color: #8b6a3e; }
    .book-author { font-size: 13px; color: #6f5f4d; margin-bottom: 6px; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .book-timeline { margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2d6c4; }
    .timeline-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; padding: 4px 6px; border-radius: 6px; }
    .timeline-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    
    .timeline-item.locked { opacity: 0.4; }
    .timeline-item.locked .timeline-dot { background: #ddd; border: 1px dashed #bbb; }
    .timeline-item.locked .timeline-text { color: #aaa; font-style: italic; }

    .timeline-item.unlocked.milestone-1 { background: rgba(99, 179, 237, 0.08); }
    .timeline-item.unlocked.milestone-1 .timeline-dot { background: #63b3ed; box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2); }
    .timeline-item.unlocked.milestone-1 .timeline-text { color: #2c5282; font-weight: 600; }

    .timeline-item.unlocked.milestone-2 { background: rgba(246, 173, 85, 0.08); }
    .timeline-item.unlocked.milestone-2 .timeline-dot { background: #f6ad55; box-shadow: 0 0 0 3px rgba(246, 173, 85, 0.25); }
    .timeline-item.unlocked.milestone-2 .timeline-text { color: #7c2d12; font-weight: 600; }

    .timeline-item.unlocked.milestone-3 {
      background: rgba(74, 222, 128, 0.08);
    }
    
    .timeline-item.unlocked.milestone-3 .timeline-dot {
      background: #4ade80;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.25);
    }
    
    .timeline-item.unlocked.milestone-3 .timeline-text {
      color: #166534;
      font-weight: 600;
    }

    .timeline-item.unlocked.milestone-4 {
      background: rgba(168, 85, 247, 0.1);
    }
    
    .timeline-item.unlocked.milestone-4 .timeline-dot {
      background: #a855f7;
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.3);
    }
    
    .timeline-item.unlocked.milestone-4 .timeline-text {
      color: #581c87;
      font-weight: 700;
    }

    .btn-delete { padding: 6px 12px; border-radius: 6px; border: 1px solid #a65b4b; background: transparent; color: #a65b4b; font-size: 11px; cursor: pointer; float: right; transition: all 0.15s ease; }
    .btn-delete:hover { background: #a65b4b; color: #fffdf8; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MANUAL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-content {
      background: linear-gradient(135deg, #fffdf8, #fefbf3);
      padding: 40px; border-radius: 16px; border: 1px solid #e2d6c4;
      max-width: 420px; width: 90%; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .demo-banner {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 1px solid #1d4ed8;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .demo-banner.active {
      display: flex;
    }
    @media (max-width: 768px) {
      .top-bar {
        flex-wrap: wrap;
        padding: 12px 16px;
      }
      
      .top-bar h1 {
        font-size: 16px;
        width: 100%;
        margin-bottom: 10px;
      }
      
      .search-container {
        width: 100%;
        order: 3;
        margin-top: 10px;
      }
      
      .auth-controls {
        margin-left: 0;
        gap: 8px;
      }
      
      #viewArchiveBtn {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .user-info {
        font-size: 12px;
      }
      
      .btn-sign-out {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      /* Demo banner mobile */
      .demo-banner {
        padding: 10px 16px;
        font-size: 13px;
        line-height: 1.4;
      }
      
      .columns-container {
        overflow-x: auto;
        overflow-y: hidden;
      }
      
      .column {
        min-width: 280px;
        flex-shrink: 0;
      }
    }
    </style>
</head>
<body>

    <div class="top-bar">
      <h1>Dusty's Reading Flow Tool</h1>
      <div class="search-container">
        <input type="text" class="search-field" placeholder="Search books...">
        <div class="search-results" id="searchResults"></div>
      </div>

    <button class="auth-btn" id="viewArchiveBtn" style="display: none;">
      üèÜ View Archive
    </button>
      
      <div class="auth-controls">
        <button class="auth-btn" id="googleSignIn">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
          Sign In
        </button>
        <div class="user-info" id="userInfo">
          <span id="userName"></span>
          <button class="btn-sign-out" id="signOutBtn">Sign Out</button>
        </div>
      </div>
    </div>

    <div class="demo-banner" id="demoBanner">
      Viewing demo - Sign in to start your own reading flow!
    </div>

    <div class="columns-container">
        <div class="column column-1">
            <div class="column-header"><div class="column-title">ADDED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-2">
            <div class="column-header"><div class="column-title">READING</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-3">
            <div class="column-header"><div class="column-title">FINISHED ‚Äî NOT RATED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
        <div class="column column-4">
            <div class="column-header"><div class="column-title">FINISHED & RATED</div><div class="column-subtitle">0 books</div></div>
            <div class="column-content"></div>
        </div>
    </div>

    <div id="manualModal" class="modal-overlay">
      <div class="modal-content">
        <h2 style="color:#2a241f; margin-bottom:12px; font-size:24px">Manual Entry</h2>
        <p style="color:#6f5f4d; margin-bottom:24px; font-size:14px">Add details for a book not found in search.</p>
        <input type="text" id="manualTitle" class="search-field" style="margin-bottom:12px" placeholder="Book Title">
        <input type="text" id="manualAuthor" class="search-field" style="margin-bottom:24px" placeholder="Author Name">
        <div style="display:flex; gap:12px">
          <button onclick="closeManualModal()" class="btn-sign-out" style="color:#a65b4b; border-color:#a65b4b; flex:1">Cancel</button>
          <button onclick="submitManualEntry()" class="auth-btn" style="flex:1; justify-content:center; background:#3a2f25; color:white; border:none">Add to Flow</button>
        </div>
      </div>
    </div>

    <div id="archiveModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
        <div style="text-align: center; margin-bottom: 20px;">
          <img src="/booktrophy.png" alt="Trophy" style="width: 80px; height: 80px; filter: brightness(0) saturate(100%) invert(60%) sepia(80%) saturate(500%) hue-rotate(10deg) brightness(95%) contrast(90%); margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="archiveTitle" style="color:#2a241f; font-size:28px; margin: 0; flex: 1;">Your Archive</h2>
            <button onclick="closeArchiveModal()" class="btn-sign-out" style="color:#2a241f; border-color:#2a241f;">Close</button>
          </div>
        </div>
        <p style="color:#6f5f4d; margin-bottom:24px; font-size:14px;">Books you've conquered and celebrated.</p>
        <div id="archiveList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
          <!-- Archive cards will go here -->
        </div>
      </div>
    </div>

    <div id="editModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 480px;">
        <h2 style="color:#2a241f; margin-bottom:20px; font-size:24px">Edit Book</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#2a241f; margin-bottom:6px;">Book Title</label>
          <input type="text" id="editTitle" class="search-field" placeholder="Enter book title">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#2a241f; margin-bottom:6px;">Author</label>
          <input type="text" id="editAuthor" class="search-field" placeholder="Enter author name">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#1e40af; margin-bottom:6px;">üìö Added</label>
          <input type="date" id="editAdded" class="search-field" style="background: #e6f2ff; border-color: #93c5fd;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#c2410c; margin-bottom:6px;">üìñ Started</label>
          <input type="date" id="editStarted" class="search-field" style="background: #fff7ed; border-color: #fb923c;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#d97706; margin-bottom:6px;">‚úÖ Finished</label>
          <input type="date" id="editFinished" class="search-field" style="background: #fff9ed; border-color: #f5a623;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:13px; font-weight:600; color:#15803d; margin-bottom:6px;">‚≠ê Rated</label>
          <input type="date" id="editRated" class="search-field" style="background: #f0fdf4; border-color: #4ade80;">
        </div>

        <div id="archivedDateField" style="margin-bottom:24px; display:none;">
          <label style="display:block; font-size:13px; font-weight:600; color:#581c87; margin-bottom:6px;">üèÜ Archived</label>
          <input type="date" id="editArchived" class="search-field" style="background: #f3e8ff; border-color: #a855f7;">
        </div>
        
        <div style="display:flex; gap:12px">
          <button onclick="closeEditModal()" class="btn-sign-out" style="color:#a65b4b; border-color:#a65b4b; flex:1">Cancel</button>
          <button onclick="submitEdit()" class="auth-btn" style="flex:1; justify-content:center; background:#3a2f25; color:white; border:none">Save Changes</button>
        </div>
      </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
  // FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDe-AQ70nJ9Lah8ojh4pivmxD0KglHWGHo",
    authDomain: "dusty-s-reading-flow.firebaseapp.com",
    projectId: "dusty-s-reading-flow",
    storageBucket: "dusty-s-reading-flow.firebasestorage.app",
    messagingSenderId: "378730506034",
    appId: "1:378730506034:web:16cc698d8ebb54430d592b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  let searchTimeout;
  let draggedCard = null;

  const DEMO_BOOKS = {
      column1: [
        { title: "The Hobbit", author: "J.R.R. Tolkien", addedDate: "Dec 1, 2024" }
      ],
      column2: [
        { title: "1984", author: "George Orwell", addedDate: "Nov 15, 2024", startedDate: "Nov 20, 2024" }
      ],
      column3: [
        { title: "Project Hail Mary", author: "Andy Weir", addedDate: "Oct 10, 2024", startedDate: "Oct 15, 2024", finishedDate: "Nov 28, 2024" }
      ],
      column4: [
        { title: "Dune", author: "Frank Herbert", addedDate: "Sep 5, 2024", startedDate: "Sep 10, 2024", finishedDate: "Oct 22, 2024", ratedDate: "Oct 23, 2024" }
      ]
    };
    
    function loadDemoBooks() {
      [1,2,3,4].forEach(i => {
        const col = document.querySelector(`.column-${i} .column-content`);
        col.innerHTML = '';
        (DEMO_BOOKS[`column${i}`] || []).forEach(b => {
          const card = createBookCard(b, i);
          card.style.opacity = '0.85';
          col.appendChild(card);
        });
      });
      updateAllCounts();
      document.getElementById('demoBanner').classList.add('active');
    }

  // AUTH OBSERVER
  auth.onAuthStateChanged(async (user) => {
    const signInBtn = document.getElementById('googleSignIn');
    const userInfo = document.getElementById('userInfo');
    const userNameDisplay = document.getElementById('userName');

    if (user) {
      currentUser = user;
      signInBtn.style.display = 'none';
      userInfo.style.display = 'flex';
      userNameDisplay.textContent = user.displayName || user.email;
      document.querySelector('.top-bar h1').textContent = `${user.displayName || 'Your'}'s Reading Flow Tool`;
      document.getElementById('viewArchiveBtn').style.display = 'inline-flex';
      await loadBooks();
      document.getElementById('demoBanner').classList.remove('active'); // Add this line
      setupDropZones();
    } else {
      currentUser = null;
      signInBtn.style.display = 'inline-flex';
      userInfo.style.display = 'none';
      document.querySelector('.top-bar h1').textContent = "Dusty's Reading Flow Tool";
      document.getElementById('viewArchiveBtn').style.display = 'none';
      
      // Load demo books
      loadDemoBooks();
      setupDropZones();
    }
  });

  document.getElementById('googleSignIn').addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider).catch(e => console.error(e));
  });

  document.getElementById('signOutBtn').addEventListener('click', async () => {
    if (confirm('Sign out?')) await auth.signOut();
  });

  // UTILITIES
  function getTodayDate() {
    return new Date().toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // SEARCH & MANUAL ENTRY
  async function searchBooks(query) {
    try {
      const response = await fetch(`https://openlibrary.org/search.json?title=${encodeURIComponent(query)}&limit=5`);
      const data = await response.json();
      return data.docs.map(b => ({ title: b.title, author: b.author_name ? b.author_name[0] : 'Unknown Author' }));
    } catch { return []; }
  }

  function displayResults(books) {
    const container = document.getElementById('searchResults');
    let html = books.map(b => `
      <div class="search-result" onclick="addBook('${escapeHtml(b.title)}','${escapeHtml(b.author)}')">
        <div class="result-title">${b.title}</div>
        <div class="result-author">${b.author}</div>
      </div>
    `).join('');
    html += `<div class="search-result" onclick="openManualModal()" style="color:#4285f4; font-weight:bold; border-top:1px solid #d2c3ad">+ Can't find it? Add Manually</div>`;
    container.innerHTML = html;
  }

  // Updated Search & Manual Entry logic
  function openManualModal() { 
    // Clear fields so they are fresh every time it opens
    document.getElementById('manualTitle').value = '';
    document.getElementById('manualAuthor').value = '';
    
    document.getElementById('manualModal').style.display = 'flex'; 
    document.getElementById('searchResults').innerHTML = '';
    
    // Optional: Focus the title field automatically
    setTimeout(() => document.getElementById('manualTitle').focus(), 50);
  }

  function closeManualModal() { 
    document.getElementById('manualModal').style.display = 'none'; 
  }

  async function submitManualEntry() {
    const t = document.getElementById('manualTitle').value.trim();
    const a = document.getElementById('manualAuthor').value.trim() || 'Unknown Author';
    
    if(t) { 
      await addBook(t, a); 
      // Modal closing now handles the "freshness" for the next open
      closeManualModal(); 
    } else { 
      alert("Please enter a title"); 
    }
  }

    function openArchiveModal() {
      document.getElementById('archiveModal').style.display = 'flex';
      
      // Update the title with the user's name
      const archiveTitle = document.getElementById('archiveTitle');
      if (currentUser && archiveTitle) {
        archiveTitle.textContent = `${currentUser.displayName || 'Your'}'s Archive`;
      }
      
      loadArchivedBooks();
    }
    
    function closeArchiveModal() {
      document.getElementById('archiveModal').style.display = 'none';
    }
    
    async function loadArchivedBooks() {
      if (!currentUser) return;
      
      const archiveList = document.getElementById('archiveList');
      archiveList.innerHTML = '<p style="text-align:center; color:#7a6a57;">Loading...</p>';
      
      try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('archived').get();
        
        if (snapshot.empty) {
          archiveList.innerHTML = '<p style="text-align:center; color:#7a6a57; padding: 40px;">No archived books yet. Finish and rate some books to see them here! ‚≠ê</p>';
          return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
          const book = doc.data();
          html += `
              <div class="book-card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #d4af37; box-shadow: 0 6px 14px rgba(212, 175, 55, 0.3);">
                <button class="btn-delete" onclick="editArchivedBook('${doc.id}')" style="background: transparent; color: #4285f4; border-color: #4285f4; margin-right: 8px;">Edit</button>
                <button class="btn-delete" onclick="deleteArchivedBook('${doc.id}')">Delete</button>
                <div class="book-title">${book.title}</div>
                <div class="book-author">${book.author}</div>
                <div class="book-timeline">
                  <div class="timeline-item unlocked milestone-1"><div class="timeline-dot"></div><div class="timeline-text">Added ${book.addedDate}</div></div>
                  <div class="timeline-item unlocked milestone-2"><div class="timeline-dot"></div><div class="timeline-text">Started ${book.startedDate}</div></div>
                  <div class="timeline-item unlocked milestone-3"><div class="timeline-dot"></div><div class="timeline-text">Finished ${book.finishedDate}</div></div>
                  <div class="timeline-item unlocked milestone-4"><div class="timeline-dot"></div><div class="timeline-text">Rated ${book.ratedDate}</div></div>
                  <div class="timeline-item unlocked" style="background: rgba(168, 85, 247, 0.15);"><div class="timeline-dot" style="background: #a855f7;"></div><div class="timeline-text" style="color: #581c87; font-weight: 700;">‚≠ê Archived ${book.archivedDate}</div></div>
                </div>
              </div>
            `;
        });
        
        archiveList.innerHTML = html;
      } catch (error) {
        console.error('Error loading archive:', error);
        archiveList.innerHTML = '<p style="text-align:center; color:#a65b4b;">Error loading archive. Please try again.</p>';
      }
    }
    async function deleteArchivedBook(docId) {
      if (!confirm('Permanently delete this book from your archive?')) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).collection('archived').doc(docId).delete();
        await loadArchivedBooks(); // Reload the archive to show updated list
      } catch (error) {
        console.error('Error deleting archived book:', error);
        alert('Error deleting book. Please try again.');
      }
    }

  // Updated addBook to ensure search field is cleared
  async function addBook(title, author) {
      if (!currentUser) { 
        alert("Sign in with Google to start tracking your own books!"); 
        return; 
      }
    
    const col = document.querySelector('.column-1 .column-content');
    const bookCard = createBookCard({ title, author, addedDate: getTodayDate() }, 1);
    col.prepend(bookCard);
    
    // Clear the main search field and results dropdown
    document.querySelector('.search-field').value = '';
    document.getElementById('searchResults').innerHTML = '';
    
    updateAllCounts();
    await saveBooks();
  }

  function createBookCard(book, colIdx) {
    const card = document.createElement('div');
    card.className = 'book-card';
    card.setAttribute('draggable', 'true');

    // Safety net logic
    const aDate = (book.addedDate && book.addedDate !== 'N/A') ? book.addedDate : "Recently";
    const sDate = colIdx >= 2 ? ((book.startedDate && book.startedDate !== 'N/A') ? book.startedDate : "Recently") : "...";
    const fDate = colIdx >= 3 ? ((book.finishedDate && book.finishedDate !== 'N/A') ? book.finishedDate : "Recently") : "...";
    const rDate = colIdx >= 4 ? ((book.ratedDate && book.ratedDate !== 'N/A') ? book.ratedDate : "Recently") : "...";

      

    card.innerHTML = `
      <button class="btn-delete" onclick="${colIdx === 4 ? 'archiveBook(this)' : 'deleteBook(this)'}">
        ${colIdx === 4 ? '‚≠ê Archive' : 'Delete'}
      </button>
      <button class="btn-delete" onclick="editBook(this)" style="background: transparent; color: #4285f4; border-color: #4285f4; margin-right: 8px;">Edit</button>
      <div class="book-title">${book.title}</div>
      <div class="book-author">${book.author}</div>
      <div class="book-timeline">
        <div class="timeline-item unlocked milestone-1"><div class="timeline-dot"></div><div class="timeline-text">Added ${aDate}</div></div>
        <div class="timeline-item ${colIdx >= 2 ? 'unlocked milestone-2' : 'locked'}"><div class="timeline-dot"></div><div class="timeline-text">Started ${sDate}</div></div>
        <div class="timeline-item ${colIdx >= 3 ? 'unlocked milestone-3' : 'locked'}"><div class="timeline-dot"></div><div class="timeline-text">Finished ${fDate}</div></div>
        <div class="timeline-item ${colIdx >= 4 ? 'unlocked milestone-4' : 'locked'}"><div class="timeline-dot"></div><div class="timeline-text">Rated ${rDate}</div>
      </div>

      </div>
    `;

    card.dataset.addedDate = aDate;
    card.dataset.startedDate = colIdx >= 2 ? (sDate === "..." ? "" : sDate) : "";
    card.dataset.finishedDate = colIdx >= 3 ? (fDate === "..." ? "" : fDate) : "";
    card.dataset.ratedDate = colIdx >= 4 ? (rDate === "..." ? "" : rDate) : "";

    card.addEventListener('dragstart', () => { draggedCard = card; card.classList.add('dragging'); });
    card.addEventListener('dragend', () => { draggedCard = null; card.classList.remove('dragging'); });
    return card;
  }

  function setupDropZones() {
      document.querySelectorAll('.column-content').forEach((content, i) => {
        // 1. Highlight column when card enters
        content.addEventListener('dragover', (e) => {
          e.preventDefault(); // Required to allow drop
          if (!content.classList.contains('drag-over')) {
            content.classList.add('drag-over');
          }
        });
    
        // 2. Remove highlight when card leaves
        content.addEventListener('dragleave', () => {
          content.classList.remove('drag-over');
        });
    
        // 3. Handle the drop
        content.addEventListener('drop', async (e) => {
          e.preventDefault();
          content.classList.remove('drag-over'); // Clear feedback immediately
          
          if (!draggedCard) return;
          
          const targetIdx = i + 1;
          
          // Update dates based on column
          if (targetIdx >= 2 && (!draggedCard.dataset.startedDate || draggedCard.dataset.startedDate === "Recently")) {
            draggedCard.dataset.startedDate = getTodayDate();
          }
          if (targetIdx >= 3 && (!draggedCard.dataset.finishedDate || draggedCard.dataset.finishedDate === "Recently")) {
            draggedCard.dataset.finishedDate = getTodayDate();
          }
          if (targetIdx >= 4 && (!draggedCard.dataset.ratedDate || draggedCard.dataset.ratedDate === "Recently")) {
            draggedCard.dataset.ratedDate = getTodayDate();
          }

          
          const newCard = createBookCard({
            title: draggedCard.querySelector('.book-title').textContent,
            author: draggedCard.querySelector('.book-author').textContent,
            addedDate: draggedCard.dataset.addedDate,
            startedDate: draggedCard.dataset.startedDate,
            finishedDate: draggedCard.dataset.finishedDate,
            ratedDate: draggedCard.dataset.ratedDate
          }, targetIdx);
          
          content.prepend(newCard);
          draggedCard.remove();
          updateAllCounts();
          await saveBooks();
        });
      });
    }

  async function saveBooks() {
    if (!currentUser) return;
    const data = { column1: [], column2: [], column3: [], column4: [] };
    document.querySelectorAll('.column').forEach((col, i) => {
      col.querySelectorAll('.book-card').forEach(c => {
        data[`column${i+1}`].push({
          title: c.querySelector('.book-title').textContent,
          author: c.querySelector('.book-author').textContent,
          addedDate: c.dataset.addedDate,
          startedDate: c.dataset.startedDate,
          finishedDate: c.dataset.finishedDate,
          ratedDate: c.dataset.ratedDate
        });
      });
    });
    await db.collection('users').doc(currentUser.uid).collection('books').doc('data').set(data);
  }

  async function loadBooks() {
    const doc = await db.collection('users').doc(currentUser.uid).collection('books').doc('data').get();
    if (doc.exists) {
      const data = doc.data();
      [1,2,3,4].forEach(i => {
        const col = document.querySelector(`.column-${i} .column-content`);
        col.innerHTML = '';
        (data[`column${i}`] || []).forEach(b => col.appendChild(createBookCard(b, i)));
      });
    }
    updateAllCounts();
  }

  function updateAllCounts() {
    document.querySelectorAll('.column').forEach((col, i) => {
      const count = col.querySelectorAll('.book-card').length;
      col.querySelector('.column-subtitle').textContent = `${count} book${count !== 1 ? 's' : ''}`;
    });
  }

  async function deleteBook(btn) { btn.closest('.book-card').remove(); updateAllCounts(); await saveBooks(); }

    async function archiveBook(btn) {
      const card = btn.closest('.book-card');
      const bookData = {
        title: card.querySelector('.book-title').textContent,
        author: card.querySelector('.book-author').textContent,
        addedDate: card.dataset.addedDate,
        startedDate: card.dataset.startedDate,
        finishedDate: card.dataset.finishedDate,
        ratedDate: card.dataset.ratedDate,
        archivedDate: getTodayDate()
      };
      
      // Save to archive collection
      await db.collection('users').doc(currentUser.uid).collection('archived').add(bookData);
      
      // Remove from view
      card.remove();
      updateAllCounts();
      await saveBooks();
    }
    
    let editingCard = null;

    function editBook(btn) {
      editingCard = btn.closest('.book-card');
      const title = editingCard.querySelector('.book-title').textContent;
      const author = editingCard.querySelector('.book-author').textContent;
      
      // Find which column the card is in
      const columnContent = editingCard.closest('.column-content');
      const columnIndex = Array.from(document.querySelectorAll('.column-content')).indexOf(columnContent) + 1;
      
      document.getElementById('editTitle').value = title;
      document.getElementById('editAuthor').value = author;
      document.getElementById('editAdded').value = dateToISO(editingCard.dataset.addedDate);
      document.getElementById('editStarted').value = dateToISO(editingCard.dataset.startedDate);
      document.getElementById('editFinished').value = dateToISO(editingCard.dataset.finishedDate);
      document.getElementById('editRated').value = dateToISO(editingCard.dataset.ratedDate);
      
      // Update labels to show locked status
      const startedLabel = document.querySelector('label[for="editStarted"]') || document.querySelectorAll('#editModal label')[3];
      const finishedLabel = document.querySelector('label[for="editFinished"]') || document.querySelectorAll('#editModal label')[4];
      const ratedLabel = document.querySelector('label[for="editRated"]') || document.querySelectorAll('#editModal label')[5];
      
      if (columnIndex < 2) {
        startedLabel.innerHTML = 'üìñ Started Date <span style="color:#999; font-weight:400; font-size:11px;">(Not unlocked yet)</span>';
      } else {
        startedLabel.innerHTML = 'üìñ Started Date';
      }
      
      if (columnIndex < 3) {
        finishedLabel.innerHTML = '‚úÖ Finished Date <span style="color:#999; font-weight:400; font-size:11px;">(Not unlocked yet)</span>';
      } else {
        finishedLabel.innerHTML = '‚úÖ Finished Date';
      }
      
      if (columnIndex < 4) {
        ratedLabel.innerHTML = '‚≠ê Rated Date <span style="color:#999; font-weight:400; font-size:11px;">(Not unlocked yet)</span>';
      } else {
        ratedLabel.innerHTML = '‚≠ê Rated Date';
      }
      
      document.getElementById('editModal').style.display = 'flex';
    }
    
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('archivedDateField').style.display = 'none';
      editingCard = null;
      editingArchivedId = null;
    }
    
    function dateToISO(dateStr) {
      if (!dateStr || dateStr === 'Recently' || dateStr === '...') return '';
      try {
        const date = new Date(dateStr);
        return date.toISOString().split('T')[0];
      } catch {
        return '';
      }
    }
    
    function formatDate(isoDate) {
      if (!isoDate) return 'Recently';
      const date = new Date(isoDate);
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    async function submitEdit() {
      const title = document.getElementById('editTitle').value.trim();
      const author = document.getElementById('editAuthor').value.trim() || 'Unknown Author';
      const addedDate = formatDate(document.getElementById('editAdded').value);
      const startedDate = formatDate(document.getElementById('editStarted').value);
      const finishedDate = formatDate(document.getElementById('editFinished').value);
      const ratedDate = formatDate(document.getElementById('editRated').value);
      
      if (!title) {
        alert('Title is required');
        return;
      }
      
      // Check if editing an archived book
      if (editingArchivedId) {
        const archivedDate = formatDate(document.getElementById('editArchived').value);
        
        await db.collection('users').doc(currentUser.uid).collection('archived').doc(editingArchivedId).update({
          title,
          author,
          addedDate,
          startedDate,
          finishedDate,
          ratedDate,
          archivedDate
        });
        
        await loadArchivedBooks();
        closeEditModal();
        return;
      }
      
      // Otherwise editing a regular card
      if (!editingCard) return;
      
      // Find which column the card is in
      const columnContent = editingCard.closest('.column-content');
      const columnIndex = Array.from(document.querySelectorAll('.column-content')).indexOf(columnContent) + 1;
      
      // Create updated card
      const newCard = createBookCard({
        title,
        author,
        addedDate,
        startedDate,
        finishedDate,
        ratedDate
      }, columnIndex);
      
      // Replace old card with new card
      editingCard.replaceWith(newCard);
      
      closeEditModal();
      await saveBooks();
    }

    let editingArchivedId = null;

    async function editArchivedBook(docId) {
      try {
        const doc = await db.collection('users').doc(currentUser.uid).collection('archived').doc(docId).get();
        if (!doc.exists) return;
        
        const book = doc.data();
        editingArchivedId = docId;
        
        document.getElementById('editTitle').value = book.title;
        document.getElementById('editAuthor').value = book.author;
        document.getElementById('editAdded').value = dateToISO(book.addedDate);
        document.getElementById('editStarted').value = dateToISO(book.startedDate);
        document.getElementById('editFinished').value = dateToISO(book.finishedDate);
        document.getElementById('editRated').value = dateToISO(book.ratedDate);
        document.getElementById('editArchived').value = dateToISO(book.archivedDate);
        
        // Show archived date field
        document.getElementById('archivedDateField').style.display = 'block';
        
        document.getElementById('editModal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading archived book:', error);
      }
    }

  document.querySelector('.search-field').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const q = e.target.value.trim();
      
      // Immediately clear if the user deletes their text
      if (q.length === 0) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }
    
      if (q.length > 2) {
        searchTimeout = setTimeout(async () => {
          const results = await searchBooks(q);
          displayResults(results);
        }, 300);
      }
    });

  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('book-title')) window.open(`https://www.goodreads.com/search?q=${encodeURIComponent(e.target.textContent)}`, '_blank');
    if (!e.target.closest('.search-container')) document.getElementById('searchResults').innerHTML = '';
      document.getElementById('viewArchiveBtn').addEventListener('click', openArchiveModal);
  });
</script>
</body>
</html>
