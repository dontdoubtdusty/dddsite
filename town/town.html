<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Cozy Village - Physics</title>
    <style>
        body {
            background-color: #f0f8ff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none; 
        }

        #game-world {
            width: 500px;
            height: 400px;
            background-color: #855E42;
            border: 10px solid #5C4033;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background-image: radial-gradient(#9e7052 20%, transparent 20%),
                              radial-gradient(#9e7052 20%, transparent 20%);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
        }

        .entity {
            width: 40px;
            height: 40px;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            /* We removed z-index here because JS will handle it now! */
        }

        #player {
            background-color: #ff6b6b;
            color: white;
            border-radius: 50%;
        }

        #neighbor {
            background-color: #4ecdc4;
            color: white;
            border-radius: 50%;
        }

        .furniture {
            width: 40px;
            height: 40px;
            background-color: #ffe66d;
            position: absolute;
            border-radius: 5px;
            border: 2px solid #d4c04d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }

        .held {
            border-color: #ff6b6b;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 9999 !important; /* Always on top when held */
        }

        #dialogue-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: white;
            border: 4px solid #4ecdc4;
            border-radius: 15px;
            padding: 15px;
            display: none;
            font-size: 14px;
            z-index: 10000;
        }
        
        #instructions {
            position: absolute;
            top: -40px;
            width: 100%;
            text-align: center;
            color: #555;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="game-world">
        <div id="instructions">Arrows: Move ‚Ä¢ SPACE: Action</div>
        
        <div id="plant" class="furniture">ü™¥</div>
        <div id="neighbor" class="entity">üêª</div>
        <div id="player" class="entity">üôÇ</div>

        <div id="dialogue-box">
            <strong style="color:#4ecdc4">Bear:</strong> <span id="dialogue-text">...</span>
        </div>
    </div>

    <script>
        const player = document.getElementById('player');
        const neighbor = document.getElementById('neighbor');
        const plant = document.getElementById('plant');
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueText = document.getElementById('dialogue-text');
        
        // --- GAME VARIABLES ---
        
        // Define objects with Position and Size
        // We use objects now to make collision math cleaner
        let playerObj = { x: 230, y: 300, w: 40, h: 40, el: player };
        let neighborObj = { x: 230, y: 50, w: 40, h: 40, el: neighbor };
        let plantObj = { x: 100, y: 200, w: 40, h: 40, el: plant, isHeld: false };

        // List of things that block the player
        let colliders = [neighborObj, plantObj];

        const speed = 4;
        const keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false, " ":false };

        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
            if (e.key === ' ' && !e.repeat) handleInteraction();
        });
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
        });

        // --- GAME LOOP ---
        function gameLoop() {
            let dx = 0;
            let dy = 0;

            if (keys.ArrowUp) dy = -speed;
            if (keys.ArrowDown) dy = speed;
            if (keys.ArrowLeft) dx = -speed;
            if (keys.ArrowRight) dx = speed;

            // PREDICT: Where will we be?
            let nextX = playerObj.x + dx;
            let nextY = playerObj.y + dy;

            // 1. COLLISION CHECK (Can we move there?)
            // We check X and Y separately to allow "sliding" against walls
            if (!checkCollision(nextX, playerObj.y)) {
                playerObj.x = nextX;
            }
            if (!checkCollision(playerObj.x, nextY)) {
                playerObj.y = nextY;
            }

            // Boundary Checks (Walls)
            if (playerObj.x < 0) playerObj.x = 0;
            if (playerObj.y < 0) playerObj.y = 0;
            if (playerObj.x > 460) playerObj.x = 460;
            if (playerObj.y > 360) playerObj.y = 360;

            // 2. UPDATE POSITIONS & DEPTH SORTING
            updateEntity(playerObj);
            updateEntity(neighborObj);
            updateEntity(plantObj);

            // Hide dialogue if moving
            if (dx !== 0 || dy !== 0) dialogueBox.style.display = 'none';

            requestAnimationFrame(gameLoop);
        }

        // --- PHYSICS HELPERS ---

        function checkCollision(newX, newY) {
            // Create a temporary rectangle for where the player WANTS to be
            let pRect = { x: newX, y: newY, w: playerObj.w, h: playerObj.h };

            for (let obj of colliders) {
                // Ignore the plant if we are holding it!
                if (obj === plantObj && plantObj.isHeld) continue;

                if (isOverlapping(pRect, obj)) {
                    return true; // Hit something!
                }
            }
            return false; // Path is clear
        }

        // Standard AABB Collision Formula (Axis-Aligned Bounding Box)
        function isOverlapping(rect1, rect2) {
            return (rect1.x < rect2.x + rect2.w &&
                    rect1.x + rect1.w > rect2.x &&
                    rect1.y < rect2.y + rect2.h &&
                    rect1.y + rect1.h > rect2.y);
        }

        function updateEntity(obj) {
            if (obj === plantObj && obj.isHeld) {
                obj.x = playerObj.x;
                obj.y = playerObj.y - 20; // Visual offset
            }

            obj.el.style.left = obj.x + 'px';
            obj.el.style.top = obj.y + 'px';
            
            // DEPTH SORTING: The lower the Y, the higher the Z-index.
            // We usually add a base value (100) to ensure it's above the floor
            if (!obj.isHeld) {
                obj.el.style.zIndex = Math.floor(obj.y);
            }
        }

        // --- INTERACTION ---

        function handleInteraction() {
            if (plantObj.isHeld) {
                // Drop
                plantObj.isHeld = false;
                plantObj.el.classList.remove('held');
                // Snap to grid
                plantObj.x = Math.round(plantObj.x / 10) * 10;
                plantObj.y = Math.round(plantObj.y / 10) * 10;
            } else {
                // Check Distances
                let dPlant = getDistance(playerObj, plantObj);
                let dNeigh = getDistance(playerObj, neighborObj);

                if (dPlant < 50) {
                    plantObj.isHeld = true;
                    plantObj.el.classList.add('held');
                } else if (dNeigh < 60) {
                    showDailyDialogue();
                }
            }
        }

        function getDistance(o1, o2) {
            return Math.hypot(o1.x - o2.x, o1.y - o2.y);
        }

        function showDailyDialogue() {
            const date = new Date();
            const msgs = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            dialogueText.innerText = "Happy " + msgs[date.getDay()] + "!";
            dialogueBox.style.display = 'block';
        }

        // Start
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
